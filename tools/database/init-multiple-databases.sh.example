#!/bin/bash
# Multi-Database Initialization Script for PostgreSQL
# This script creates multiple databases in a single PostgreSQL instance
# Place this file in tools/database/ and make it executable
# Usage: Set POSTGRES_MULTIPLE_DATABASES environment variable with comma-separated database names

set -e

POSTGRES_USER="${POSTGRES_USER:-postgres}"

# Check if POSTGRES_MULTIPLE_DATABASES is set
if [ -z "$POSTGRES_MULTIPLE_DATABASES" ]; then
    echo "Warning: POSTGRES_MULTIPLE_DATABASES not set. Skipping multi-database initialization."
    exit 0
fi

echo "Starting multi-database initialization..."

# Function to create a database
create_database() {
    local db_name=$1
    echo "Creating database: $db_name"
    
    # Check if database already exists
    DB_EXISTS=$(psql -U "$POSTGRES_USER" -tAc "SELECT 1 FROM pg_database WHERE datname='$db_name'")
    
    if [ "$DB_EXISTS" = "1" ]; then
        echo "Database $db_name already exists, skipping..."
    else
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
            CREATE DATABASE $db_name;
            GRANT ALL PRIVILEGES ON DATABASE $db_name TO $POSTGRES_USER;
            COMMENT ON DATABASE $db_name IS 'Created by multi-database initialization script';
EOSQL
        echo "Database $db_name created successfully."
    fi
}

# Parse comma-separated database list
IFS=',' read -ra DATABASES <<< "$POSTGRES_MULTIPLE_DATABASES"

# Create each database
for db in "${DATABASES[@]}"; do
    # Trim whitespace from database name
    db=$(echo "$db" | xargs)
    
    # Skip empty entries
    if [ -z "$db" ]; then
        continue
    fi
    
    # Validate database name (basic check)
    if [[ ! "$db" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]]; then
        echo "Warning: Invalid database name '$db'. Skipping..."
        continue
    fi
    
    create_database "$db"
done

echo "Multi-database initialization completed!"
echo "Created databases: $POSTGRES_MULTIPLE_DATABASES"

